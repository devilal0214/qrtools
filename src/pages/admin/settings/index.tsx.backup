import { useState, useEffect } from 'react';
import Head from 'next/head';
import AdminLayout from '@/components/AdminLayout';
import { collection, doc, getDoc, setDoc } from 'firebase/firestore';
import { db } from '@/lib/firebase';
import { toast } from 'react-hot-toast';

export default function AdminSettingsPage() {
  const [settings, setSettings] = useState({
    watermark: {
      enabled: true,
      logoUrl: '',
      text: 'Created with QR Tools',
      position: 'bottom-right',
      size: 'small',
      opacity: 0.7
    },
    trial: {
      enabled: true,
      durationDays: 14,
      features: ['tracking', 'removeWatermark', 'frames', 'analytics']
    },
    smtp: {
      host: '',
      port: '',
      user: '',
      password: '',
      from: ''
    },
    emailTemplates: {
      welcome: {
        subject: 'Welcome to QR Generator',
        body: 'Thank you for joining QR Generator. We\'re excited to have you on board!'
      },
      passwordReset: {
        subject: 'Password Reset Request',
        body: 'You requested a password reset. Click the link below to reset your password:'
      },
      verifyEmail: {
        subject: 'Verify Your Email',
        body: 'Please verify your email address by clicking the link below:'
      },
      trialExpiring: {
        subject: 'Your Trial is Expiring Soon',
        body: 'Your premium trial will expire in {days} days. Upgrade now to continue enjoying premium features!'
      }
    },
    analytics: {
      ipTrackingEnabled: true,
      gpsTrackingEnabled: false
    }
  });
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState('');

  useEffect(() => {
    const fetchSettings = async () => {
      try {
        const settingsDoc = await getDoc(doc(db, 'settings', 'config'));
        if (settingsDoc.exists()) {
          setSettings(prevSettings => ({
            ...prevSettings,
            ...settingsDoc.data()
          }));
        }
      } catch (error) {
        console.error('Error fetching settings:', error);
        setError('Failed to load settings');
      } finally {
        setLoading(false);
      }
    };

    fetchSettings();
  }, []);

  const handleSave = async () => {
    setSaving(true);
    setError('');
    try {
      await setDoc(doc(db, 'settings', 'config'), settings);
      toast.success('Settings saved successfully');
    } catch (error) {
      console.error('Error saving settings:', error);
      setError('Failed to save changes');
    } finally {
      setSaving(false);
    }
  };

  if (loading) {
    return (
      <AdminLayout>
        <div className="animate-pulse">Loading...</div>
      </AdminLayout>
    );
  }

  return (
    <AdminLayout>
      <Head>
        <title>Admin Settings - Dashboard</title>
      </Head>

      <div className="max-w-4xl mx-auto space-y-6">
        <h1 className="text-2xl font-bold text-gray-900">Settings</h1>

        {error && (
          <div className="bg-red-50 text-red-600 p-4 rounded-lg">
            {error}
          </div>
        )}

        {/* Watermark Settings */}
        <div className="bg-white rounded-lg shadow p-6 space-y-4">
          <h2 className="text-lg font-medium text-gray-900">Watermark Settings</h2>
          <div className="grid grid-cols-2 gap-4">
            <div className="col-span-2">
              <label className="flex items-center gap-2">
                <input
                  type="checkbox"
                  checked={settings.watermark.enabled}
                  onChange={(e) => setSettings({
                    ...settings,
                    watermark: { ...settings.watermark, enabled: e.target.checked }
                  })}
                  className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                />
                <span className="text-sm font-medium text-gray-700">Enable Watermark for Free/Non-Premium Users</span>
              </label>
            </div>
            <div className="col-span-2">
              <label className="block text-sm font-medium text-gray-700">Watermark Logo URL</label>
              <input
                type="text"
                value={settings.watermark.logoUrl}
                onChange={(e) => setSettings({
                  ...settings,
                  watermark: { ...settings.watermark, logoUrl: e.target.value }
                })}
                placeholder="https://example.com/logo.png"
                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
              <p className="mt-1 text-xs text-gray-500">Leave empty to use text watermark only</p>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700">Watermark Text</label>
              <input
                type="text"
                value={settings.watermark.text}
                onChange={(e) => setSettings({
                  ...settings,
                  watermark: { ...settings.watermark, text: e.target.value }
                })}
                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700">Position</label>
              <select
                value={settings.watermark.position}
                onChange={(e) => setSettings({
                  ...settings,
                  watermark: { ...settings.watermark, position: e.target.value }
                })}
                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              >
                <option value="bottom-right">Bottom Right</option>
                <option value="bottom-left">Bottom Left</option>
                <option value="bottom-center">Bottom Center</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700">Size</label>
              <select
                value={settings.watermark.size}
                onChange={(e) => setSettings({
                  ...settings,
                  watermark: { ...settings.watermark, size: e.target.value }
                })}
                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              >
                <option value="small">Small</option>
                <option value="medium">Medium</option>
                <option value="large">Large</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700">Opacity: {settings.watermark.opacity}</label>
              <input
                type="range"
                min="0.1"
                max="1"
                step="0.1"
                value={settings.watermark.opacity}
                onChange={(e) => setSettings({
                  ...settings,
                  watermark: { ...settings.watermark, opacity: parseFloat(e.target.value) }
                })}
                className="mt-1 block w-full"
              />
            </div>
          </div>
        </div>

        {/* Trial Settings */}
        <div className="bg-white rounded-lg shadow p-6 space-y-4">
          <h2 className="text-lg font-medium text-gray-900">Trial Settings</h2>
          <div className="grid grid-cols-2 gap-4">
            <div className="col-span-2">
              <label className="flex items-center gap-2">
                <input
                  type="checkbox"
                  checked={settings.trial.enabled}
                  onChange={(e) => setSettings({
                    ...settings,
                    trial: { ...settings.trial, enabled: e.target.checked }
                  })}
                  className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                />
                <span className="text-sm font-medium text-gray-700">Enable Free Trial for New Users</span>
              </label>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700">Trial Duration (Days)</label>
              <input
                type="number"
                value={settings.trial.durationDays}
                onChange={(e) => setSettings({
                  ...settings,
                  trial: { ...settings.trial, durationDays: parseInt(e.target.value) }
                })}
                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
          </div>
        </div>

        {/* SMTP Settings */
        <div className="bg-white rounded-lg shadow p-6 space-y-4">
          <h2 className="text-lg font-medium text-gray-900">SMTP Settings</h2>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700">SMTP Host</label>
              <input
                type="text"
                value={settings.smtp.host}
                onChange={(e) => setSettings({
                  ...settings,
                  smtp: { ...settings.smtp, host: e.target.value }
                })}
                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700">SMTP Port</label>
              <input
                type="text"
                value={settings.smtp.port}
                onChange={(e) => setSettings({
                  ...settings,
                  smtp: { ...settings.smtp, port: e.target.value }
                })}
                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700">SMTP User</label>
              <input
                type="text"
                value={settings.smtp.user}
                onChange={(e) => setSettings({
                  ...settings,
                  smtp: { ...settings.smtp, user: e.target.value }
                })}
                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700">SMTP Password</label>
              <input
                type="password"
                value={settings.smtp.password}
                onChange={(e) => setSettings({
                  ...settings,
                  smtp: { ...settings.smtp, password: e.target.value }
                })}
                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
            <div className="col-span-2">
              <label className="block text-sm font-medium text-gray-700">From Email</label>
              <input
                type="email"
                value={settings.smtp.from}
                onChange={(e) => setSettings({
                  ...settings,
                  smtp: { ...settings.smtp, from: e.target.value }
                })}
                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
          </div>
        </div>

        {/* Email Templates */}
        <div className="bg-white rounded-lg shadow p-6 space-y-6">
          <div>
            <h2 className="text-lg font-medium text-gray-900">Email Templates</h2>
            <p className="mt-1 text-sm text-gray-500">Customize email templates sent to users. Use placeholders: {`{username}`}, {`{email}`}, {`{link}`}, {`{days}`}</p>
          </div>
          
          {Object.entries(settings.emailTemplates).map(([key, template]) => {
            const templateDescriptions = {
              welcome: 'Sent when a new user signs up',
              passwordReset: 'Sent when user requests password reset',
              verifyEmail: 'Sent to verify user email address',
              trialExpiring: 'Sent when trial period is about to expire'
            };
            
            return (
              <div key={key} className="space-y-4 p-4 bg-gray-50 rounded-lg">
                <div>
                  <h3 className="text-sm font-semibold text-gray-900 capitalize">{key.replace(/([A-Z])/g, ' $1').trim()} Email</h3>
                  <p className="text-xs text-gray-500 mt-0.5">{templateDescriptions[key]}</p>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700">Subject Line</label>
                  <input
                    type="text"
                    value={template.subject}
                    onChange={(e) => setSettings({
                      ...settings,
                      emailTemplates: {
                        ...settings.emailTemplates,
                        [key]: { ...template, subject: e.target.value }
                      }
                    })}
                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    placeholder="Email subject"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700">Email Body (HTML supported)</label>
                  <textarea
                    value={template.body}
                    onChange={(e) => setSettings({
                      ...settings,
                      emailTemplates: {
                        ...settings.emailTemplates,
                        [key]: { ...template, body: e.target.value }
                      }
                    })}
                    rows={6}
                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 font-mono text-sm"
                    placeholder="Email body content..."
                  />
                </div>
              </div>
            );
          })}
        </div>

        {/* Analytics & Tracking Settings */}
        <div className="bg-white rounded-lg shadow p-6 space-y-4">
          <div>
            <h2 className="text-lg font-medium text-gray-900">Analytics & Tracking</h2>
            <p className="mt-1 text-sm text-gray-500">Configure how QR code scans are tracked and analyzed</p>
          </div>
          
          <div className="space-y-4">
            <div className="flex items-start p-4 bg-gray-50 rounded-lg">
              <input
                type="checkbox"
                id="ipTracking"
                checked={settings.analytics.ipTrackingEnabled}
                onChange={(e) => setSettings({
                  ...settings,
                  analytics: { ...settings.analytics, ipTrackingEnabled: e.target.checked }
                })}
                className="mt-1 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
              />
              <div className="ml-3 flex-1">
                <label htmlFor="ipTracking" className="text-sm font-medium text-gray-900">
                  IP-Based Location Tracking
                </label>
                <p className="text-sm text-gray-500 mt-1">
                  Track approximate location (city/region) based on IP address. This is enabled by default and works for all scans without user permission.
                </p>
              </div>
            </div>

            <div className="flex items-start p-4 bg-gray-50 rounded-lg">
              <input
                type="checkbox"
                id="gpsTracking"
                checked={settings.analytics.gpsTrackingEnabled}
                onChange={(e) => setSettings({
                  ...settings,
                  analytics: { ...settings.analytics, gpsTrackingEnabled: e.target.checked }
                })}
                className="mt-1 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
              />
              <div className="ml-3 flex-1">
                <label htmlFor="gpsTracking" className="text-sm font-medium text-gray-900">
                  GPS-Based Precise Location Tracking
                </label>
                <p className="text-sm text-gray-500 mt-1">
                  Request precise GPS coordinates from users when they scan QR codes. Users will be prompted to share their location in their browser.
                </p>
                {settings.analytics.gpsTrackingEnabled && (
                  <div className="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p className="text-sm text-yellow-800">
                      <strong>‚ö†Ô∏è Note:</strong> Users must grant location permission. Not all users will accept this request. GPS tracking provides exact latitude/longitude coordinates.
                    </p>
                  </div>
                )}
              </div>
            </div>

            <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
              <h4 className="text-sm font-medium text-blue-900 mb-2">üìç Tracking Comparison</h4>
              <ul className="text-sm text-blue-700 space-y-2">
                <li className="flex gap-2">
                  <span>‚Ä¢</span>
                  <span><strong>IP Tracking:</strong> Automatic, city/region level accuracy, works for all users</span>
                </li>
                <li className="flex gap-2">
                  <span>‚Ä¢</span>
                  <span><strong>GPS Tracking:</strong> Requires permission, exact coordinates (latitude/longitude), higher accuracy</span>
                </li>
                <li className="flex gap-2">
                  <span>‚Ä¢</span>
                  <span><strong>Best Practice:</strong> Enable both for better data coverage - GPS when available, IP as fallback</span>
                </li>
              </ul>
            </div>
          </div>
        </div>

        {/* Save Button */}
        <div className="flex justify-end">
          <button
            onClick={handleSave}
            disabled={saving}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
          >
            {saving ? 'Saving...' : 'Save Changes'}
          </button>
        </div>
      </div>
    </AdminLayout>
  );
}
