rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: check if user is admin by checking both role and isAdmin fields
    function isAdmin() {
      return request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true
      );
    }

    /**********************
     * QR CODES
     **********************/
    match /qrcodes/{qrId} {
      // Any logged-in user can create a QR
      allow create: if request.auth != null;

      // Anyone can read a QR document (so redirects work publicly)
      allow read: if true;

      // Allow public update for scan count (admin SDK + client fallback)
      allow update: if true;

      // Only owner can delete
      allow delete: if request.auth != null &&
        resource.data.userId == request.auth.uid;
    }

    /**********************
     * SCANS (analytics)
     **********************/
    match /scans/{scanId} {
      // âœ… Allow anyone to read scans (your UI is already behind AuthGuard)
      allow read: if true;

      // Writes are normally from admin SDK (which bypasses rules),
      // but we allow client create too if ever needed.
      allow create: if true;

      // Do not allow client updates/deletes
      allow update, delete: if false;
    }
    
    /**********************
     * PUBLIC ANALYTICS (Sharable links)
     **********************/
    match /publicAnalytics/{qrId} {
      allow read: if true;
      allow write: if request.auth != null;
      allow update, delete: if request.auth != null;
    }

    /**********************
     * CONTACTS
     **********************/
    match /contacts/{contactId} {
      allow create: if request.auth != null;

      // Public read for contact view pages
      allow read: if true;

      // Owner can update their contacts
      allow update: if request.auth != null &&
        resource.data.userId == request.auth.uid;

      // Only owner can delete
      allow delete: if request.auth != null &&
        resource.data.userId == request.auth.uid;
    }

    /**********************
     * USERS
     **********************/
    match /users/{userId} {
      allow read: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      );

      allow write: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      );
    }

    /**********************
     * PLANS
     **********************/
    match /plans/{planId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**********************
     * SUBSCRIPTIONS
     **********************/
    match /subscriptions/{subId} {
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      allow write: if isAdmin();
    }

    /**********************
     * TRANSACTIONS
     **********************/
    match /transactions/{transId} {
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid || isAdmin()
      );

      // Clients can create their own transaction record
      allow create: if request.auth != null;

      // Only admin can update or delete
      allow update, delete: if isAdmin();
    }

    /**********************
     * PAYMENT GATEWAYS
     **********************/
    match /payment_gateways/{gatewayId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    /**********************
     * GLOBAL SETTINGS (Updated for watermark, trial, email templates)
     **********************/
    match /settings/{settingId} {
      // Allow public read for watermark settings, trial config, etc.
      allow read: if true;
      
      // Only admin can write settings
      allow write: if isAdmin();
    }

    /**********************
     * EMAIL JOBS
     **********************/
    match /email_jobs/{jobId} {
      // Only admin can create/read/update jobs
      allow create: if isAdmin();
      allow read, update: if isAdmin();
    }

    /**********************
     * LOGIN ATTEMPTS (server only)
     **********************/
    match /loginAttempts/{attempt} {
      allow read, write: if false;
    }

    /**********************
     * SHORT URLS
     **********************/
    match /shorturls/{document} {
      allow create: if request.auth != null &&
        request.resource.data.userId == request.auth.uid;

      // Public read for redirect
      allow read: if true;

      // Public update for click counting
      allow update: if true;

      allow delete: if request.auth != null &&
        resource.data.userId == request.auth.uid;
    }

    /**********************
     * BANNERS
     **********************/
    match /banners/{bannerId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**********************
     * VIRTUAL TOURS
     **********************/
    match /virtualTours/{tourId} {
      allow read: if true;
      allow write: if request.auth != null;

      match /scenes/{sceneId} {
        allow read: if get(/databases/$(database)/documents/virtualTours/$(tourId)).data.isPublic == true ||
          (request.auth != null &&
            get(/databases/$(database)/documents/virtualTours/$(tourId)).data.userId == request.auth.uid);

        allow write: if request.auth != null &&
          get(/databases/$(database)/documents/virtualTours/$(tourId)).data.userId == request.auth.uid;
      }
    }

    /**********************
     * FLIPBOOKS
     **********************/
    match /flipbooks/{flipbookId} {
      // Public can read if flipbook is public, otherwise owner only
      allow read: if true;

      // Only authenticated users can create flipbooks
      allow create: if request.auth != null;

      // Only owner can update their flipbooks (allow view count updates)
      allow update: if request.auth != null &&
        (resource.data.userId == request.auth.uid || 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views']));

      // Only owner can delete their flipbooks
      allow delete: if request.auth != null &&
        resource.data.userId == request.auth.uid;
    }
  }
}
