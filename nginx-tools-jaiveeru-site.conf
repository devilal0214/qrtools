server {
  listen 80;
  listen [::]:80;
  listen 443 ssl http2;
  listen [::]:443 ssl http2;

  {{ssl_certificate_key}}
  {{ssl_certificate}}
  server_name tools.jaiveeru.site;  # Changed to tools.jaiveeru.site
  {{root}}

  {{nginx_access_log}}
  {{nginx_error_log}}

  # Force HTTPS redirect
  if ($scheme != "https") {
    return 301 https://$host$request_uri;
  }

  # ‚úÖ Proxy to Next.js app running on port 3000 (QR Code App)
  location / {
    proxy_pass http://localhost:3000;  # Changed to port 3000 for QR app
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    
    # üîß CRITICAL: IP Forwarding Headers for QR Analytics
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
    proxy_set_header X-Client-IP $remote_addr;
    
    # ‚è∞ Timeout settings to prevent 504 Gateway Timeout
    proxy_connect_timeout 120s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;
    send_timeout 120s;
    client_body_timeout 120s;
    
    # üì§ Allow large file uploads (QR codes, virtual tours)
    client_max_body_size 50M;
    client_body_buffer_size 128k;
    
    # üöÄ CRITICAL: Disable buffering to stream requests immediately
    proxy_request_buffering off;
    proxy_buffering off;
    
    # Proxy buffer sizes
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
    proxy_busy_buffers_size 8k;
  }

  # ‚úÖ Fix for Next.js static assets (JS, CSS, fonts, etc.)
  location ^~ /_next/static/ {
    alias /home/jaiveeru-tools/htdocs/tools.jaiveeru.site/.next/static/;
    access_log off;
    add_header Cache-Control "public, max-age=31536000, immutable";
  }

  # ‚úÖ Serve uploaded files (QR codes, virtual tour scenes, etc.)
  location ^~ /uploads/ {
    alias /home/jaiveeru-tools/htdocs/tools.jaiveeru.site/public/uploads/;
    access_log off;
    add_header Cache-Control "public, max-age=86400";
    add_header Access-Control-Allow-Origin "*";
    try_files $uri $uri/ =404;
  }

  # Let's Encrypt/SSL challenge
  location ~ /.well-known {
    auth_basic off;
    allow all;
  }

  {{settings}}

  index index.html;

  # Static file cache for other assets
  location ~* ^.+\.(css|js|jpg|jpeg|gif|png|ico|gz|svg|svgz|ttf|otf|woff|woff2|eot|mp4|ogg|ogv|webm|webp|zip|swf)$ {
    add_header Access-Control-Allow-Origin "*";
    expires max;
    access_log off;
  }

  # Stop processing if file exists
  if (-f $request_filename) {
    break;
  }
}